<!DOCTYPE HTML>


<html>
  <head>
    <title>Arran by fergustaylor</title>
    <meta charset="utf-8">
    	<meta name="viewport" content="width=device-width, initial-scale=1" />
    	<meta http-equiv="content-language" content="en-uk" />
    	<meta name="og:image" content="https://fergustaylor.github.io/images/avatar.jpg">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="https://fergustaylor.github.io/css/main.css" />
    
  </head>
  
  <body id="top">

<header id="header">
  
  <a href="../" class="image avatar"><img src="https://fergustaylor.github.io/images/avatar.jpg" alt="" /></a>
  
  
        <h1><strong>Arran</strong></h1>
        <h1>A practice at using ggplot2, geom_sf and leaflet to demonstrate Arran SIMD data.</h1>

<nav id="sidebar">
			<ul>
        
				<li><a href="../">Home</a></li>
				<li><a href="https://fergustaylor.github.io/post">Archive</a></li>
			
			</ul>
		</nav>
        
</header>
      
      
      <div id="main">

      <h1 id="load-packages">Load Packages</h1>

<p>First I need to load up the packages I’ll need</p>

<div class="highlighter-rouge"><pre class="highlight"><code>library(sf)

## Linking to GEOS 3.4.2, GDAL 2.1.2, proj.4 4.9.1

library(ggplot2) #development version!
## devtools::install_github("tidyverse/ggplot2")
library(tidyverse)

## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr

## Conflicts with tidy packages ----------------------------------------------

## filter(): dplyr, stats
## lag():    dplyr, stats

library(readr)
library(cowplot)

## 
## Attaching package: 'cowplot'

## The following object is masked from 'package:ggplot2':
## 
##     ggsave

library(sp)
library(gridExtra)

## 
## Attaching package: 'gridExtra'

## The following object is masked from 'package:dplyr':
## 
##     combine

library(dplyr)
library(ggrepel)
library(plyr)

## -------------------------------------------------------------------------

## You have loaded plyr after dplyr - this is likely to cause problems.
## If you need functions from both plyr and dplyr, please load plyr first, then dplyr:
## library(plyr); library(dplyr)

## -------------------------------------------------------------------------

## 
## Attaching package: 'plyr'

## The following objects are masked from 'package:dplyr':
## 
##     arrange, count, desc, failwith, id, mutate, rename, summarise,
##     summarize

## The following object is masked from 'package:purrr':
## 
##     compact
</code></pre>
</div>

<h1 id="import-postcode-data">Import Postcode Data</h1>

<p>Now I import my data. I filter for the Arran postcodes, (since Arran all
begins ‘KA27’).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#Add download commands for data.
## Finding the Arran coordinates
arrancoordinates &lt;- read.csv("../alldata/ukpostcodes.csv") %&gt;%
 filter(substr(postcode,1,4)=="KA27")

#Find way to replace with existing SIMD shape files
arransubsect &lt;- read_sf("../alldata/Scotland_pcs_2011") %&gt;%
filter(substr(label,1,4)=="KA27")
</code></pre>
</div>

<h1 id="import-simd-data">Import SIMD data</h1>

<p>Now I load the SIMD data, containing the geometries (shapefiles) and
SIMD data (percentiles, etc)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>reorderedvector&lt;- c("S01011174", "S01011171", "S01011177", "S01011176", "S01011175", "S01011173", "S01011172" )

arran2016 &lt;- read_sf("../alldata/SG_SIMD_2016")[c(4672,4666,4669,4671,4667,4668,4670),] %&gt;%
  slice(match(reorderedvector, DataZone))

Arrandz2012 &lt;- c(4409,4372,4353,4352,4351,4350,4349)

arran2012 &lt;- read_sf("../alldata/SG_SIMD_2012")[Arrandz2012,]
arran2009 &lt;- read_sf("../alldata/SG_SIMD_2009")[Arrandz2012,]
arran2006 &lt;- read_sf("../alldata/SG_SIMD_2006")[Arrandz2012,]
arran2004 &lt;- read_sf("../alldata/SG_SIMD_2004")[Arrandz2012,]

sharedvariables &lt;- intersect(colnames(arran2016), colnames(arran2012)) %&gt;%
  intersect(colnames(arran2009))  %&gt;%
  intersect(colnames(arran2006))  %&gt;%
  intersect(colnames(arran2004))
  
arran20162 &lt;- arran2016 %&gt;%
  select(sharedvariables) %&gt;%
  mutate(year="2016")
arran20122 &lt;- arran2012 %&gt;%
  select(sharedvariables) %&gt;%
  mutate(year="2012")
arran20092 &lt;- arran2009 %&gt;%
  select(sharedvariables) %&gt;%
  mutate(year="2009")
arran20062 &lt;- arran2006 %&gt;%
  select(sharedvariables) %&gt;%
  mutate(year="2006")
arran20042 &lt;- arran2004 %&gt;%
  select(sharedvariables) %&gt;%
  mutate(year="2004")

arransimd &lt;- rbind(arran20162,arran20122,arran20092,arran20062,arran20042) %&gt;%
mutate(
    lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
    lat = map_dbl(geometry, ~st_centroid(.x)[[2]])
    )

arransimd$listID &lt;- revalue(arransimd$DataZone,
               c("S01004409"="S01004409/S01011174", "S01004372"="S01004372/S01011171", "S01004353"="S01004353/S01011177", "S01004352"="S01004352/S01011176", "S01004351"="S01004351/S01011175", "S01004350"="S01004350/S01011173", "S01004349"="S01004349/S01011172", "S01011174"="S01004409/S01011174", "S01011171"="S01004372/S01011171", "S01011177"="S01004353/S01011177", "S01011176"="S01004352/S01011176", "S01011175"="S01004351/S01011175", "S01011173"="S01004350/S01011173", "S01011172"="S01004349/S01011172"))
</code></pre>
</div>

<h1 id="initial-plots">Initial Plots</h1>

<p>The reason I’ve downloaded all the DataZones shapefiles individually is
because they change between 2016 and 2012. See the small differences.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>rbind(arran20162,arran20122) %&gt;%
  ggplot() +
  geom_sf(aes(fill = DataZone)) +
  facet_wrap('year') +
  theme_grey() +
  theme(legend.position="none") +
  theme(axis.text.x=element_text(angle=45, hjust = 1))
</code></pre>
</div>

<p><img src="Code_files/figure-markdown_strict/unnamed-chunk-4-1.png" alt="" /></p>

<h1 id="arran-simd-health-percentiles">Arran SIMD Health Percentiles</h1>

<p>Now I want to look at percentile data.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>arransimd %&gt;%
filter(listID == unique(arransimd$listID))  %&gt;%
  ggplot() +
  geom_sf(aes(fill = Percentile)) +
  facet_wrap('year', nrow=1) +
  theme_grey() +
  geom_text(aes(label = Percentile, x = lon, y = lat), size = 2, colour = "white") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  theme(legend.position="bottom")  
</code></pre>
</div>

<p><img src="Code_files/figure-markdown_strict/unnamed-chunk-5-1.png" alt="" /></p>

<p>There we are. The SIMD health percentiles of Arran zones throughout SIMD
history. And I’ve learned a little bit about graphics in R.</p>

<p><a href="percentileplot.png">See this image at a larger size.</a></p>

<p>Now I want to overlay the postcodes by Datazone. To do this I’ve
converted both the Arran coordinates and Arran (2016) shapefiles into
spatial points/polygons, converted them into a common CRS, and then
compared them by using ‘plyr::over()’. This gives me the object
‘namingdzpostcode’, with the postcode rows grouped into IDs
(unidentified datazones).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>simple.sf &lt;- st_as_sf(arrancoordinates, coords=c('longitude','latitude'))
st_crs(simple.sf) &lt;- 4326

exampleshapes &lt;- sf:::as_Spatial(arran2016$geometry) %&gt;%
  spTransform(CRS("+proj=longlat +datum=WGS84"))

examplepoints &lt;- sf:::as_Spatial(simple.sf$geom) %&gt;%
  spTransform(CRS("+proj=longlat +datum=WGS84"))

namingdzpostcode &lt;- over(exampleshapes, examplepoints, returnList = TRUE)
</code></pre>
</div>

<p>I can then take a member reference from the orginal postcode list, which
gives me a selection of the rows in that DZ. For simplicity I’ve written
this as a new function.</p>

<h1 id="mutate-arrancoordinates-to-label-the-ids">Mutate arrancoordinates to label the IDs</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>function100 &lt;- function(argument) 
{
  argument &lt;- arrancoordinates[namingdzpostcode[[argument]],] %&gt;% mutate(DataZone=argument)
}

arrancoordinates &lt;- lapply(1:7,function100)
arrancoordinates &lt;- rbind(arrancoordinates[[1]], arrancoordinates[[2]], arrancoordinates[[3]], arrancoordinates[[4]], arrancoordinates[[5]], arrancoordinates[[6]], arrancoordinates[[7]])

arrancoordinates$listID &lt;- revalue(as.character(arrancoordinates$DataZone),
               c('1'="S01004409/S01011174", '2'="S01004372/S01011171", '3'="S01004353/S01011177", '4'="S01004352/S01011176", '5'="S01004351/S01011175", '6'="S01004350/S01011173", '7'="S01004349/S01011172"))
</code></pre>
</div>

<h1 id="labelling-the-namingdzpostcode-list">Labelling the namingdzpostcode list</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>names(namingdzpostcode) &lt;- c(unique(arransimd$listID))
</code></pre>
</div>

<h1 id="subsecting-the-coordinates">Subsecting the coordinates</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>coordinateexample &lt;- arrancoordinates %&gt;%
  select(postcode, latitude, longitude, listID) %&gt;%
  filter(listID == unique(arrancoordinates$listID)[1])
</code></pre>
</div>

<h1 id="individual-datazones">Individual Datazones</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>filter(arransimd, year == 2016) %&gt;%
  ggplot() +
  theme_grey() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  theme(legend.position="none") +
  facet_wrap('listID', nrow = 1) +
  geom_sf(aes(fill = DataZone))
</code></pre>
</div>

<p><img src="Code_files/figure-markdown_strict/unnamed-chunk-10-1.png" alt="" /></p>

<h1 id="plotting-datazones-by-facet_grid">Plotting DataZones by facet_grid</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>arransimd %&gt;%
ggplot() +
  geom_sf(aes(fill = Percentile)) +
  facet_grid(listID ~ year) +
  theme_grey() +
  geom_text(aes(label = Percentile, x = lon, y = lat), size = 2, colour = "white") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  theme(legend.position="bottom")
</code></pre>
</div>

<p><img src="Code_files/figure-markdown_strict/unnamed-chunk-11-1.png" alt="" /></p>

<p><a href="/Rplotpercentiles.png">See this plot at a proper scale.</a></p>

<h1 id="postcodes-overlayed-onto-datazone">Postcodes overlayed onto datazone.</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>ggplot() +
  geom_sf(data=arransimd) +
  geom_point(data=arrancoordinates, 
             mapping = aes(x = longitude, y = latitude), 
             size=1) +
  theme_grey() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326)) +
  facet_wrap('listID', nrow = 1)
</code></pre>
</div>

<p><img src="Code_files/figure-markdown_strict/unnamed-chunk-12-1.png" alt="" /></p>

<p><a href="/Rplot15.png">See this plot at a larger scale.</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>thisfunction2 &lt;- function(argument) 
{arransimd %&gt;%
  filter(listID == argument)  %&gt;%
  ggplot() +
  geom_sf() +
  theme_grey() +
  geom_point(data = filter(arrancoordinates, listID == argument), 
             mapping = aes(x = longitude, y = latitude), size=1) +
  geom_text_repel(data = filter(arrancoordinates, listID == argument), 
            aes(label = filter(arrancoordinates, 
                               listID == argument)$postcode, 
                x = longitude, y = latitude), size=2) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))
}

output2 &lt;- lapply(unique(arransimd$listID), thisfunction2)
grid.arrange(output2[[1]], output2[[2]], output2[[3]], output2[[4]], output2[[5]], output2[[6]], output2[[7]], ncol = 7)
</code></pre>
</div>

<p><a href="/Rplot14.png">See this plot at a larger scale.</a></p>

<h1 id="plots">Plots</h1>

<div class="highlighter-rouge"><pre class="highlight"><code>function10 &lt;- function(argument)
{
a &lt;- arransimd %&gt;%
mutate(
    lon = map_dbl(geometry, ~st_centroid(.x)[[1]]),
    lat = map_dbl(geometry, ~st_centroid(.x)[[2]])
    ) %&gt;%
filter(listID == argument)  %&gt;%
  ggplot() +
  geom_sf(aes(fill = Percentile)) +
  facet_wrap('year') +
  theme_grey() +
  geom_text(aes(label = Percentile, x = lon, y = lat), size = 2, colour = "white") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  theme(legend.position="bottom") +
  scale_fill_continuous(limits = c(40,80))

b &lt;- arransimd %&gt;%
  filter(listID == argument)  %&gt;%
  ggplot() +
  geom_sf(data = arransubsect) +
  theme_grey() +
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  theme(legend.position="bottom") +
  geom_sf(aes(fill = DataZone))

c &lt;- arransimd %&gt;%
  filter(listID == argument)  %&gt;%
  ggplot() +
  geom_sf() +
  theme_grey() +
  geom_point(data = filter(arrancoordinates, listID == argument), 
             mapping = aes(x = longitude, y = latitude), size=1) +
  geom_text_repel(data = filter(arrancoordinates, listID == argument), 
            aes(label = filter(arrancoordinates, 
                               listID == argument)$postcode, 
                x = longitude, y = latitude), size=2) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))

grid.arrange(a, b, c, nrow = 1)
}
</code></pre>
</div>

<p><a href="/function10plots.html">See these plots at a larger scale.</a></p>

<div class="highlighter-rouge"><pre class="highlight"><code>a2 &lt;- arransimd %&gt;%
  ggplot() +
  geom_sf(aes(fill = Percentile)) +
  facet_grid(listID ~ year) +
  theme_grey() +
  geom_text(aes(label = Percentile, x = lon, y = lat), size = 2, colour = "white") +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()) +
  theme(legend.position="bottom")  

b2 &lt;- arransimd %&gt;%
  filter(year == 2016)  %&gt;%
  ggplot() +
  facet_wrap("listID") +
  geom_sf(data = arransubsect) +
  theme_grey() +
  theme(axis.text.x=element_text(angle=45, hjust = 1)) +
  theme(legend.position="none") +
  geom_sf(aes(fill = DataZone))

c2 &lt;- arransimd %&gt;%
 filter(year == 2016)  %&gt;%
  ggplot() +
  facet_wrap("listID") +
  geom_sf() +
  theme_grey() +
  geom_point(data = arrancoordinates, 
             mapping = aes(x = longitude, y = latitude), size=1) +
 geom_text_repel(data = arrancoordinates, aes(label = arrancoordinates$postcode, 
                x = longitude, y = latitude), size=2) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  coord_sf(crs= 4326, datum = sf::st_crs(4326))

grid.arrange(a2, b2, c2, ncol = 3)
</code></pre>
</div>

<p><a href="/RplotAll.png">See this plot at a larger scale.</a></p>

<p><a href="/map2.html">See this data as an interactive map.</a></p>

<p><a href="https://fergustaylor.github.io/Arran">Go back.</a></p>

      
      </div>
      
      <footer id="footer">
	<ul class="icons">
		
		 <p class="view"><a href="http://github.com/fergustaylor/Arran">View the Project on GitHub <small></small></a></p>
		
		<li><a href="//twitter.com/ferguswtaylor" target="_blank" class="icon fa-twitter"><span class="label">Twitter</span></a></li>
		
		<li><a href="//github.com/fergustaylor" target="_blank" class="icon fa-github"><span class="label">GitHub</span></a></li>
		
<li><a href="../index.xml" class="icon fa-rss" type="application/rss+xml"><span class="label">RSS</span></a></li>
		
	</ul>

	<ul class="copyright">
		
		<li>&copy; Fergus Taylor</li>
		
		<li>Images my own.</li>
		
		<li>Design: <a href="//html5up.net">HTML5 UP</a></li>
		
	</ul>
      </footer>
    
<script src="https://fergustaylor.github.io/js/jquery.min.js"></script>
<script src="https://fergustaylor.github.io/js/jquery.poptrox.min.js"></script>
<script src="https://fergustaylor.github.io/js/skel.min.js"></script>
<script src="https://fergustaylor.github.io/js/util.js"></script>

<script src="https://fergustaylor.github.io/js/main.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-107299466-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>




	</body>
</html>
