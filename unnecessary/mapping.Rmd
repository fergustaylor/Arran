---
title: "Mapping"
output:
  html_document:
    toc: yes
    toc_float: yes
  html_notebook: default
---

#Package Dependencies/ Data

```{r}
library(sf)
library(ggplot2) #development version!
## devtools::install_github("tidyverse/ggplot2")
library(tidyverse)
library(readr)
library(cowplot)
library(sp)
library(gridExtra)
library(dplyr)
library(ggrepel)
library(plyr)
library(leaflet)
library(rgdal)
library(leaflet)
```

```{r}
#arrancoordinates <- read.csv("../alldata/ukpostcodes.csv") %>%
# filter(substr(postcode,1,4)=="KA27")
```

```{r}
DZBoundaries2016 <- read_sf("../alldata/SG_SIMD_2016")
```

```{r}
arran2016 <- DZBoundaries2016[c(4672,4666,4669,4671,4667,4668,4670),]
#Reorder arran 2016
reorderedvector<- c("S01011174", "S01011171", "S01011177", "S01011176", "S01011175", "S01011173", "S01011172" )
arran2016 <- arran2016 %>%
  slice(match(reorderedvector, DataZone))
```

```{r}
simple.sf <- st_as_sf(arrancoordinates, coords=c('longitude','latitude'))
st_crs(simple.sf) <- 4326

exampleshapes <- sf:::as_Spatial(arran2016$geometry)
examplepoints <- sf:::as_Spatial(simple.sf$geom)

examplepoints <- spTransform(examplepoints, CRS("+proj=longlat +datum=WGS84"))
exampleshapes <- spTransform(exampleshapes, CRS("+proj=longlat +datum=WGS84"))

namingdzpostcode <- over(exampleshapes, examplepoints, returnList = TRUE)
```

```{r}
listID <- list(1,2,3,4,5,6,7)

function100 <- function(argument) 
{
  argument <- arrancoordinates[namingdzpostcode[[argument]],] %>% mutate(DataZone=argument)
}

newarrancoordinates <- lapply(1:7,function100)
newarrancoordinates <- rbind(newarrancoordinates[[1]], newarrancoordinates[[2]], newarrancoordinates[[3]], newarrancoordinates[[4]], newarrancoordinates[[5]], newarrancoordinates[[6]], newarrancoordinates[[7]])

newarrancoordinates$listID <- revalue(as.character(newarrancoordinates$DataZone),
               c('1'="S01004409/S01011174", '2'="S01004372/S01011171", '3'="S01004353/S01011177", '4'="S01004352/S01011176", '5'="S01004351/S01011175", '6'="S01004350/S01011173", '7'="S01004349/S01011172"))
```

///

#Coordinates

```{r}
postcodelist <- paste(unique(newarrancoordinates$listID), "Postcodes", sep=" ")
datazonelist <- paste(unique(newarrancoordinates$listID), "Datazones", sep=" ")

m = leaflet() %>% addTiles()
```

```{r}
m %>% setView(-5.227680, 55.582338, zoom = 10) %>% 

#allcoordinates
addMarkers(
    lng = newarrancoordinates$longitude, lat = newarrancoordinates$latitude,
    label = newarrancoordinates$postcode,
    labelOptions = labelOptions(noHide = F), group = "Postcode Plots") %>%
hideGroup("All Postcode Plots") %>% 

#alldatazones  
addPolygons(data=exampleshapes, 
            weight = 2, 
            label = datazonelist,
            group = "All Datazones") %>% 
hideGroup("Datazones") %>% 
  
#selectcoordinates
addMarkers(
    lng = newarrancoordinates$longitude, lat = newarrancoordinates$latitude,
    label = newarrancoordinates$postcode,
    labelOptions = labelOptions(noHide = F), group = newarrancoordinates$listID) %>% 
hideGroup(newarrancoordinates$listID) %>% 

#selectdatazone
addPolygons(data = exampleshapes[1] , 
            weight = 2, label = datazonelist[1], group = datazonelist[1]) %>% 
addPolygons(data = exampleshapes[2] , 
            weight = 2, label = datazonelist[2], group = datazonelist[2]) %>% 
addPolygons(data = exampleshapes[3] , 
            weight = 2, label = datazonelist[3], group = datazonelist[3]) %>% 
addPolygons(data = exampleshapes[4] , 
            weight = 2, label = datazonelist[4], group = datazonelist[4]) %>% 
addPolygons(data = exampleshapes[5] , 
            weight = 2, label = datazonelist[5], group = datazonelist[5]) %>% 
addPolygons(data = exampleshapes[6] , 
            weight = 2, label = datazonelist[6], group = datazonelist[6]) %>% 
addPolygons(data = exampleshapes[7] , 
            weight = 2, label = datazonelist[7], group = datazonelist[7]) %>% 
hideGroup(datazonelist[1]) %>%
hideGroup(datazonelist[2]) %>%
hideGroup(datazonelist[3]) %>%
hideGroup(datazonelist[4]) %>%
hideGroup(datazonelist[5]) %>%
hideGroup(datazonelist[6]) %>%
hideGroup(datazonelist[7]) %>%

#Layers control
addLayersControl(
    baseGroups = c("All Datazones", "Postcode Plots", "Nothing"),
    overlayGroups = c(newarrancoordinates$listID, datazonelist),
    options = layersControlOptions(collapsed = TRUE)
  )
```

Inputing example markers.
```{r}
cliniccoordinates <- read.csv("../alldata/clinics.csv") %>%
dplyr::left_join(arrancoordinates, by="postcode")
#change to character
cliniccoordinates$X <- as.character(cliniccoordinates$X)
```

```{r}
m %>% setView(-5.227680, 55.582338, zoom = 10) %>% 

#allcoordinates
addMarkers(
    lng = newarrancoordinates$longitude, lat = newarrancoordinates$latitude,
    label = newarrancoordinates$postcode,
    labelOptions = labelOptions(noHide = F), group = "All Postcode Plots") %>%
hideGroup("All Postcode Plots") %>% 

#alldatazones  
addPolygons(data=exampleshapes, 
            weight = 2, 
            label = datazonelist,
            group = "All Datazones",
            highlightOptions = highlightOptions(color = "black", weight = 2,
      bringToFront = TRUE)) %>% 
hideGroup("All Datazones") %>% 
  
#selectcoordinates
addMarkers(
    lng = newarrancoordinates$longitude, lat = newarrancoordinates$latitude,
    label = newarrancoordinates$postcode,
    labelOptions = labelOptions(noHide = F), group = newarrancoordinates$listID) %>% 
hideGroup(newarrancoordinates$listID) %>% 

#selectdatazone
addPolygons(data = exampleshapes[1] , 
            weight = 2, label = datazonelist[1], group = datazonelist[1]) %>% 
addPolygons(data = exampleshapes[2] , 
            weight = 2, label = datazonelist[2], group = datazonelist[2]) %>% 
addPolygons(data = exampleshapes[3] , 
            weight = 2, label = datazonelist[3], group = datazonelist[3]) %>% 
addPolygons(data = exampleshapes[4] , 
            weight = 2, label = datazonelist[4], group = datazonelist[4]) %>% 
addPolygons(data = exampleshapes[5] , 
            weight = 2, label = datazonelist[5], group = datazonelist[5]) %>% 
addPolygons(data = exampleshapes[6] , 
            weight = 2, label = datazonelist[6], group = datazonelist[6]) %>% 
addPolygons(data = exampleshapes[7] , 
            weight = 2, label = datazonelist[7], group = datazonelist[7]) %>% 
hideGroup(datazonelist[1]) %>%
hideGroup(datazonelist[2]) %>%
hideGroup(datazonelist[3]) %>%
hideGroup(datazonelist[4]) %>%
hideGroup(datazonelist[5]) %>%
hideGroup(datazonelist[6]) %>%
hideGroup(datazonelist[7]) %>%
  
#cliniccoordinates
addMarkers(
    lng = cliniccoordinates$longitude, lat = cliniccoordinates$latitude,
    label = cliniccoordinates$X,
    labelOptions = labelOptions(noHide = F), group = "All GP clinics") %>%
  hideGroup("All GP clinics") %>%   

#cliniccoordinates
addMarkers(
    lng = cliniccoordinates$longitude, lat = cliniccoordinates$latitude,
    label = cliniccoordinates$X,
    labelOptions = labelOptions(noHide = F), group = cliniccoordinates$X) %>%
  hideGroup(cliniccoordinates$X) %>%   
  
#Layers control
addLayersControl(
    baseGroups = c("All Datazones", "All Postcode Plots", "All GP clinics", "Nothing"),
    overlayGroups = c(newarrancoordinates$listID, datazonelist, cliniccoordinates$X),
    options = layersControlOptions(collapsed = TRUE)
  )
```

```{r}
class(arransimd)
```


bins <- c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)
pal <- colorBin("YlOrRd", domain = arransimd$Percentile, bins = bins)

arransimd10 <-arransimd
st_crs(arransimd10) <- "+proj=longlat +datum=WGS84"

arransimd10 %>% st_set_crs("+proj=longlat +datum=WGS84")



addpolygonsarran2016 <- arransimd10 %>%
  filter(year == 2016, DataZone == "S01011177")

m %>% setView(-5.227680, 55.582338, zoom = 10) %>% 
addPolygons(data = addpolygonsarran2016$geometry, 
            weight = 2) %>% 

m %>% setView(-5.227680, 55.582338, zoom = 10) %>% 
addPolygons(data = arransimd10, 
            weight = 2) %>% 
  
addLayersControl(
    overlayGroups = c(datazonelist, datazonelist[3]),
    options = layersControlOptions(collapsed = TRUE)
  )
  

leaflet() %>% 
addTiles() %>% 
  addPolygons(filter(arransimd10$geom, DataZone == "S01011177"))
  setView(-5.227680, 55.582338, zoom = 10)


  addPolygons(data = exampleshapes[1] , 
            weight = 2, label = datazonelist[1], group = datazonelist[1]) %>% 
addPolygons(data = exampleshapes[2] , 
            weight = 2, label = datazonelist[2], group = datazonelist[2]) %>% 
addPolygons(data = exampleshapes[3] , 
            weight = 2, label = datazonelist[3], group = datazonelist[3]) %>% 
addPolygons(data = exampleshapes[4] , 
            weight = 2, label = datazonelist[4], group = datazonelist[4]) %>% 
addPolygons(data = exampleshapes[5] , 
            weight = 2, label = datazonelist[5], group = datazonelist[5]) %>% 
addPolygons(data = exampleshapes[6] , 
            weight = 2, label = datazonelist[6], group = datazonelist[6]) %>% 
addPolygons(data = exampleshapes[7] , 
            weight = 2, label = datazonelist[7], group = datazonelist[7]) %>% 
hideGroup(datazonelist[1]) %>%
hideGroup(datazonelist[2]) %>%
hideGroup(datazonelist[3]) %>%
hideGroup(datazonelist[4]) %>%
hideGroup(datazonelist[5]) %>%
hideGroup(datazonelist[6]) %>%
hideGroup(datazonelist[7]) %>%


```{r}
#install.packages("geojsonio")
#library("geojsonio")

arranDZleaflet <-geojsonio::geojson_read("../alldata/SG_SIMD_2016/SG_SIMD_2016.shp", what = "sp")
class(arranDZleaflet)

leaflet() %>% 
  setView(-5.227680, 55.582338, zoom = 10) %>%
  addTiles() %>%
  addPolygons(data = arranDZleaflet)
```


